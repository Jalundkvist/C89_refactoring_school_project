// Inkluderingsdirektiv:
#include "header.h"

/******************************************************************************
* Avbrottsrutin för PCI-avbrott för I/O-port B. Vid aktivering av denna
* avbrottsrutin inaktiveras PCI-avbrott på tryckknappens PIN 13, vilket i
* detta fall är enda källan till PCI-avbrott på I/O-porten i fråga. Detta görs
* för att förhindra påverkan av kontaktstudsar, som annars kan medför att 
* multipla avbrott äger rum kort efter varandra när knappen studsar. Timer 0
* aktiveras för att efter 300 ms återaktivera PCI-avbrott på PIN 13. Ifall
* nedtryckning av tryckknappen orsakade aktuellt avbrott, så mäts aktuell
* rumstemperatur och skrivs ut i en seriell terminal. . Samtidigt nollställs Timer 1. ----------
******************************************************************************/
ISR (PCINT0_vect)
{
	button.disable_interrupt(&button);
	timer0.on(&timer0);
	
	if (button.is_pressed(&button))
	{
		timer1.update(&timer1);
		tempSensor.print_temperature(&tempSensor);
		if (!timer2.enabled)
			timer2.on(&timer2);
	}
	
	return;
}

/******************************************************************************
* Avbrottsrutin för Timer 0 i Normal Mode, vilket sker var 1.024:e millisekund
* då timern i fråga är aktiverad. Denna avbrottsrutin används för att generera 
* en de-bouncetid på 300 ms, där PCI-avbrott på PIN 13 hålls inaktiverat efter 
* ett givet avbrott för att förhindra att multipla äger rum på grund av 
* kontakstudsar. När tillräckligt många avbrott har ägt rum så att timern har 
* löpt ut, så inaktiveras Timer 0 och PCI-avbrott på PIN 13 återaktiveras.
******************************************************************************/
ISR (TIMER0_OVF_vect)
{
	timer0.count(&timer0);
	
	if (timer0.elapsed(&timer0))
	{
		timer0.off(&timer0);
		button.enable_interrupt(&button);	
	}
	
	return;
}

/******************************************************************************
* Avbrottsrutin för Timer 1 i CTC Mode, vilket sker var 1.024:e millisekund då 
* timern i fråga är aktiverad. Denna avbrottsrutin används för att mäta <-----------------
* rumstemperaturen var 60:e sekund, alternativt 60 sekunder efter senaste
* knapptryckning. Varje gång denna rutin aktiveras så räknas antalet exekverade 
* avbrott upp. När tillräckligt många avbrott har ägt rum så att timern har löpt 
* ut, så mäts rumstemperaturen och skrivs ut i terminalen.
******************************************************************************/
ISR (TIMER1_COMPA_vect)
{
	timer1.count(&timer1);	
	
	if (timer1.elapsed(&timer1))
	{
		tempSensor.print_temperature(&tempSensor);
	}
	return;
}
/******************************************************************************
* 
******************************************************************************/
ISR (TIMER2_OVF_vect) // <-----------
{
	display.update_digit(&display, tempSensor.rounded_temp);
	return;
}